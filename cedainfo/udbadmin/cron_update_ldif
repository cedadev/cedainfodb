#!/usr/local/cedainfodb/releases/current/venv/bin/python
#
# Checks if any updates are required to the LDAP server. If so it
# sends the updates to the LDAP server. Sends a notification email and writes
# any updates to a log file. Intended to be called as a cron job.
#
# If --update-anyway option is set then the script will do a full check
# for any updates required. If the option is not set then it will use
# a quick test of the userdb to see if an update is likely before doing
# the full check.
#
import subprocess
import sys
import os
import tempfile
import psycopg2
import smtplib
import time


from django.core.management import setup_environ

sys.path.append('/usr/local/cedainfodb/releases/current/cedainfo')

import cron_settings as dbsettings
setup_environ(dbsettings)

import udbadmin.LDAP as LDAP
import udbadmin.update_check as update_check
import udbadmin.udb_ldap as udb_ldap

from django.db import connections

LOG_DIR = '/datacentre/opshome/backups/ldap_accounts/updates/'
RUN_LOG = LOG_DIR + 'update_run.log'

NAME_PREFIX = 'ceda_cron_check2' 


def mail_info_msg (cmds, output, subject='', group_updated='', user_updated='', update_anyway=''):

    print 'Sending message'

    server = smtplib.SMTP('localhost')
    messageFrom = "ldapupdate <badc@stfc.ac.uk>"
    messageTo   = "andrew.harwood@stfc.ac.uk"

    msg = """From: %s
To: %s
Subject: LDAP %s server updated

The following commands have been run on the LDAP server:

%s 

Output:

%s


Group updated: %s
User updated: %s
Update anyway: %s

This message generated by %s

"""  % (messageFrom, messageTo, subject, cmds, output, group_updated, user_updated, update_anyway, sys.argv[0])
        
    server.sendmail(messageFrom, messageTo, msg)
    server.quit()

def mail_error ():
    server = smtplib.SMTP('localhost')
    messageFrom = "ldapupdate <badc@stfc.ac.uk>"
    messageTo   = "runnerharwood@gmail.com"
    subject = "Error updating LDAP"
    
    msg = """From: %s
To: %s
Subject: %s

An error occured when running the script to update the LDAP server from the userdb.

This message generated by %s

"""  % (messageFrom, messageTo, subject, sys.argv[0])
        
    server.sendmail(messageFrom, messageTo, msg)
    server.quit()    
    		
try:
    update_anyway = False

    if len(sys.argv) > 1:
     if sys.argv[1] == "--update-anyway":
	 update_anyway = True

    runlog = open(RUN_LOG, 'a')

    dbconf     = dbsettings.DATABASES['userdb']
    connection = psycopg2.connect(dbname=dbconf['NAME'], 
                                    host=dbconf['HOST'],
                                    user=dbconf['USER'], 
                                    password=dbconf['PASSWORD'])

    os.environ['TZ'] = 'GB'
    time_string = time.strftime('%Y%m%d_%H%M', time.localtime(time.time()))
    runlog.write('Running at: ' + time_string + '\n')
    runlog.close()


    user_updated  = update_check.user_updated(connection, reset=True, name=NAME_PREFIX + '_user')
    group_updated = update_check.group_updated(connection, reset=True, name=NAME_PREFIX + '_group')

    print 'User updated: ', user_updated
    print 'Group updated: ', group_updated
    #
    # Update user details if group has been updated as some groups control the 
    # description tags for the user
    #
    if user_updated or group_updated or update_anyway:
    #
    #   Update the passwd file used by the ftp servers etc
    #
	subprocess.call(["ssh", "-o", "StrictHostKeyChecking=no", "badc@tranquil.badc.rl.ac.uk", "/home/badc/software/infrastructure/accounts/src/make_and_copy_passwd_file"])

	print 'Generating ldif user commands'
	cmds = udb_ldap.ldif_all_user_updates()

	if cmds:
            print 'cmds: ', cmds
            out = ''
            out = LDAP.ldif_write(cmds)
            output = "".join(out)

            outlog = open(LOG_DIR + time_string + '_user.log', 'w')
            outlog.write(cmds +"\n")
            outlog.write('\nOutput:\n')
            outlog.write(output + '\n')
            outlog.close()

            mail_info_msg (cmds, output, subject='user', user_updated=user_updated, \
	                   group_updated=group_updated, update_anyway=update_anyway)

    if group_updated or update_anyway:
    #
    #   Update the group file used by the ftp servers etc
    #
	subprocess.call(["ssh", "-o", "StrictHostKeyChecking=no", "badc@tranquil.badc.rl.ac.uk", "/home/badc/software/infrastructure/accounts/src/make_and_copy_group_file"])


	print 'Generating ldif group commands'
	cmds = udb_ldap.ldif_all_group_updates()

	if cmds:
            print 'cmds: ', cmds
            out = ''
            out = LDAP.ldif_write(cmds)
            output = "".join(out)

            outlog = open(LOG_DIR + time_string + '_group.log', 'w')
            outlog.write(cmds +"\n")
            outlog.write('\nOutput:\n')
            outlog.write(output + '\n')
            outlog.close()

            mail_info_msg (cmds, output, subject='group', user_updated=user_updated, \
	                   group_updated=group_updated, update_anyway=update_anyway)
except:
    mail_error()    
