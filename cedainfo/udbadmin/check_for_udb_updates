#!/home/badc/software/infrastructure/cedainfo_releases/venv/bin/python
#
# Checks for updates in the userdb and sends an email if any updates are detected. Intended
# to be run as a cron job
#
import sys
import psycopg2
import smtplib

PATH = '/home/badc/software/infrastructure/cedainfo_releases/current/cedainfo'
sys.path.append(PATH)
sys.path.append(PATH + '/udbadmin')

import settings
import update_check

NAME_PREFIX = 'ceda_cron_check' 


dbsettings = settings.DATABASES['userdb']

connection = psycopg2.connect(dbname=dbsettings['NAME'], 
                                  host=dbsettings['HOST'],
                                  user=dbsettings['USER'], 
                                  password=dbsettings['PASSWORD'])
                                                                   
group_updated = update_check.group_updated(connection, reset=True, name=NAME_PREFIX + '_group')

user_updated = update_check.user_updated(connection, reset=True, name=NAME_PREFIX + '_user')


if (group_updated or user_updated):

    server = smtplib.SMTP('localhost')
    messageFrom = "udbcheck <badc@stfc.ac.uk>"
    messageTo   = "andrew.harwood@stfc.ac.uk"

    msg = """From: %s
To: %s
Subject: User database updated

Updates to the user database have been detected which will probably require and update to the 
LDAP server.

Update to groups: %s
Update to users:  %s

This message generated by %s

"""  % (messageFrom, messageTo, group_updated, user_updated, sys.argv[0])
        
    server.sendmail(messageFrom, messageTo, msg)
    server.quit()

